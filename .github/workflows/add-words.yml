name: Process Word Submission

on:
  issues:
    types: [opened, reopened]

env:
  SWIFT_IMAGE: swiftlang/swift@sha256:30154112a700a5a95fd1760716bd2040e8b735f54f081a4865823abdec67d17e
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  BOT_ACCESS_TOKEN: ${{ secrets.BOT_ACCESS_TOKEN }}

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  add:
    runs-on: ubuntu-22.04
    if: contains(github.event.issue.labels.*.name, 'add-word')

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Cache Docker Image
        id: cache-docker
        uses: actions/cache@v3
        with:
          path: /tmp/.docker-cache
          key: ${{ runner.os }}-swift-${{ env.SWIFT_IMAGE }}

      - name: Load Docker Image from Cache
        if: steps.cache-docker.outputs.cache-hit == 'true'
        run: |
          mkdir -p /tmp/.docker-cache
          docker load -i /tmp/.docker-cache/swift_image.tar

      - name: Pull Docker Image
        if: steps.cache-docker.outputs.cache-hit != 'true'
        run: |
          docker pull ${{ env.SWIFT_IMAGE }}
          mkdir -p /tmp/.docker-cache
          docker save ${{ env.SWIFT_IMAGE }} -o /tmp/.docker-cache/swift_image.tar

      - name: Export Issue Body to Text File
        run: |
          echo "${{ github.event.issue.body }}" > issue_body.txt

      - name: Set Date Variables
        id: set_date
        run: |
          echo "YEAR_MONTH=$(date +'%Y.%m')" >> $GITHUB_ENV
          echo "FULL_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Pull or Create Branch
        run: |
          git fetch origin ${{ env.YEAR_MONTH }}-word-additions || true
          if git rev-parse --verify origin/${{ env.YEAR_MONTH }}-word-additions > /dev/null 2>&1; then
            git checkout ${{ env.YEAR_MONTH }}-word-additions
            git pull origin ${{ env.YEAR_MONTH }}-word-additions --rebase
            echo "BRANCH_EXISTS=true" >> $GITHUB_ENV
          else
            git checkout -b ${{ env.YEAR_MONTH }}-word-additions
            echo "BRANCH_EXISTS=false" >> $GITHUB_ENV
          fi

      - name: Process Words and Update JSON
        run: |
          docker run --rm -e CI=true -v "$PWD:/host" -w /host $SWIFT_IMAGE swift .github/scripts/add-words.swift issue_body.txt

      - name: Check for Changes
        run: bash .github/scripts/check_for_changes.sh
        id: check

      - name: Commit Changes
        if: steps.check.outputs.changes == 'true'
        run: |
          git config user.email "markbattistella-bot@users.noreply.github.com"
          git config user.name "mb-actions[bot]"
          git add Sources/PhraseKit/Resources/*.json
          git commit -m "${{ env.FULL_DATE }} - New Word Additions - #${{ github.event.issue.number }}"
          git push origin ${{ env.YEAR_MONTH }}-word-additions --force

      - name: Check if Open PR Exists
        id: pr_exists
        run: |
          prs=$(gh pr list --head ${{ env.YEAR_MONTH }}-word-additions --state open --json number)
          if [[ "$prs" == "[]" ]]; then
            echo "PR_EXISTS=false" >> $GITHUB_ENV
          else
            echo "PR_EXISTS=true" >> $GITHUB_ENV
          fi

      - name: Create Pull Request
        id: cpr
        if: steps.check.outputs.changes == 'true' && env.PR_EXISTS == 'false'
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ env.BOT_ACCESS_TOKEN }}
          add-paths: |
            Sources/PhraseKit/Resources/_adjective.json
            Sources/PhraseKit/Resources/_adverb.json
            Sources/PhraseKit/Resources/_noun.json
            Sources/PhraseKit/Resources/_verb.json
          commit-message: ${{ env.FULL_DATE }} - New Word Additions - #${{ github.event.issue.number }}
          title: ${{ env.YEAR_MONTH }} - New Word Additions
          branch: ${{ env.YEAR_MONTH }}-word-additions
          delete-branch: false
          body: |
            Closes #${{ github.event.issue.number }}

            ## Original Message

            ${{ github.event.issue.body }}
          committer: "mb-actions[bot] <markbattistella-bot@users.noreply.github.com>"
          author: "mb-actions[bot] <markbattistella-bot@users.noreply.github.com>"

      - name: Update Issue (Success)
        if: steps.check.outputs.changes == 'true'
        uses: actions/github-script@v3
        with:
          github-token: ${{ env.GITHUB_TOKEN }}
          script: |
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Thank you! We will approve and add these words with #${{ steps.cpr.outputs.pull-request-number }}.'
            })

      - name: Update Issue (Failure)
        if: steps.check.outputs.changes != 'true'
        uses: actions/github-script@v3
        with:
          github-token: ${{ env.GITHUB_TOKEN }}
          script: |
            github.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'It looks like thereâ€™s nothing to do here!\n\nPlease ensure your submission contains valid words.'
            })
